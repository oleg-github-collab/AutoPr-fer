<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AutoprÃ¼fer - KI-gestÃ¼tzte Gebrauchtwagenanalyse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš—</text></svg>">
  <style>
    :root {
      --neon-blue: #00d4ff;
      --neon-purple: #a855f7;
      --neon-pink: #ff0080;
      --neon-green: #00ff88;
      --dark-bg: #0a0a0a;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a; color: white; overflow-x: hidden;
    }
    #particles-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .gradient-orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.5; animation: float 20s ease-in-out infinite; pointer-events: none; }
    .orb-1 { width: 600px; height: 600px; background: var(--neon-blue); top: -200px; left: -200px; }
    .orb-2 { width: 800px; height: 800px; background: var(--neon-purple); bottom: -300px; right: -300px; animation-delay: -10s; }
    .orb-3 { width: 500px; height: 500px; background: var(--neon-pink); top: 50%; left: 50%; transform: translate(-50%, -50%); animation-delay: -5s; }
    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }
    .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
    .glass-card { background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 24px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
    .glass-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent); transition: left 0.6s; }
    .glass-card:hover::before { left: 100%; }
    .glass-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0, 212, 255, 0.3); border-color: rgba(0, 212, 255, 0.5); }
    .plan-selected { border: 2px solid var(--neon-blue) !important; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(168, 85, 247, 0.1) 100%) !important; box-shadow: 0 0 30px rgba(0, 212, 255, 0.4) !important; }
    .neon-button { background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); color: white; border: none; padding: 16px 40px; border-radius: 12px; font-weight: 600; font-size: 18px; cursor: pointer; position: relative; overflow: hidden; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4); }
    .neon-button::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
    .neon-button:hover::after { width: 300px; height: 300px; }
    .neon-button:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 212, 255, 0.6); }
    .neon-button:disabled { opacity: 0.5; cursor: not-allowed; }
    .glass-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 14px 20px; border-radius: 12px; transition: all 0.3s ease; width: 100%; font-size: 16px; }
    .glass-input:focus { outline: none; border-color: var(--neon-blue); background: rgba(255, 255, 255, 0.08); box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
    .glass-input::placeholder { color: rgba(255, 255, 255, 0.4); }
    .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:9999; }
    .loading-spinner { width: 80px; height: 80px; border: 4px solid rgba(0, 212, 255, 0.2); border-top-color: var(--neon-blue); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .neon-text { background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .result-card { background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 24px; padding: 40px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5); }
    @media (max-width: 768px) { .glass-card { margin: 10px 0; } .orb-1, .orb-2, .orb-3 { width: 300px; height: 300px; } }
  </style>
</head>
<body>
  <canvas id="particles-canvas"></canvas>
  <div class="gradient-orb orb-1"></div>
  <div class="gradient-orb orb-2"></div>
  <div class="gradient-orb orb-3"></div>

  <header class="glass sticky top-0 z-50 px-6 py-4">
    <div class="container mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-400 to-purple-600 flex items-center justify-center shadow-lg">
          <span class="text-2xl">ðŸš—</span>
        </div>
        <h1 class="text-2xl font-bold"><span class="neon-text">AutoprÃ¼fer</span></h1>
      </div>
      <div class="hidden md:flex items-center space-x-6 text-sm text-gray-400">
        <span>ðŸ”’ Sicher</span>
        <span>âš¡ Schnell</span>
        <span>ðŸ¤– KI-powered</span>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-12 max-w-7xl">
    <div class="text-center mb-16">
      <h2 class="text-5xl md:text-7xl font-bold mb-6">
        <span class="text-white">Ihr Auto.</span><br />
        <span class="neon-text">Unsere KI-Analyse.</span>
      </h2>
      <p class="text-xl text-gray-400 max-w-3xl mx-auto">Professionelle Fahrzeugbewertung in Sekunden mit GPT-4o (Vision)</p>
      <div class="mt-8 flex flex-wrap justify-center gap-4">
        <div class="px-4 py-2 glass rounded-full text-sm">âœ… Keine Registrierung</div>
        <div class="px-4 py-2 glass rounded-full text-sm">âš¡ Sofort-Ergebnis</div>
        <div class="px-4 py-2 glass rounded-full text-sm">ðŸ”’ 100% Datenschutz</div>
      </div>
    </div>

    <div class="grid md:grid-cols-3 gap-8 mb-12">
      <div class="glass-card p-8 cursor-pointer plan-card" data-plan="basic">
        <div class="text-center mb-6">
          <h3 class="text-2xl font-bold mb-2">Basic</h3>
          <div class="text-5xl font-bold neon-text">4,99â‚¬</div>
          <p class="text-sm text-gray-400 mt-2">Schnellanalyse</p>
        </div>
        <ul class="space-y-4 text-gray-300">
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>Preisbewertung</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>5 Checkpunkte</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>Typische Probleme</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>Kaufempfehlung</span></li>
        </ul>
      </div>

      <div class="glass-card p-8 cursor-pointer plan-card plan-selected relative" data-plan="standard">
        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
          <span class="bg-gradient-to-r from-cyan-400 to-purple-600 text-white px-4 py-1 rounded-full text-sm font-bold">BELIEBT</span>
        </div>
        <div class="text-center mb-6">
          <h3 class="text-2xl font-bold mb-2">Standard</h3>
          <div class="text-5xl font-bold neon-text">9,99â‚¬</div>
          <p class="text-sm text-gray-400 mt-2">Detailanalyse</p>
        </div>
        <ul class="space-y-4 text-gray-300">
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>Alles aus Basic</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>Marktvergleich</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>Verhandlungstipps</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>4 Alternativen</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>3-Jahres-Prognose</span></li>
        </ul>
      </div>

      <div class="glass-card p-8 cursor-pointer plan-card" data-plan="premium">
        <div class="text-center mb-6">
          <h3 class="text-2xl font-bold mb-2">Premium</h3>
          <div class="text-5xl font-bold neon-text">24,99â‚¬</div>
          <p class="text-sm text-gray-400 mt-2">Vollgutachten</p>
        </div>
        <ul class="space-y-4 text-gray-300">
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>Alles aus Standard</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>30-Punkte-Check</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>5-Jahres-Prognose</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>Risikobewertung</span></li>
          <li class="flex items-start"><span class="text-green-400 mr-3">âœ“</span><span>PDF-Export</span></li>
        </ul>
      </div>
    </div>

    <div class="glass-card p-10">
      <h3 class="text-3xl font-bold mb-8 text-center neon-text">Fahrzeugdaten eingeben</h3>
      <form id="vehicleForm">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-300">Marke *</label>
            <input type="text" name="brand" required class="glass-input" placeholder="z.B. Volkswagen" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-300">Modell *</label>
            <input type="text" name="model" required class="glass-input" placeholder="z.B. Golf 7" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-300">Baujahr *</label>
            <input type="number" name="year" required min="1900" max="2026" class="glass-input" placeholder="z.B. 2018" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-300">Kilometerstand *</label>
            <input type="number" name="mileage" required min="0" class="glass-input" placeholder="z.B. 85000" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-300">Preis (â‚¬) *</label>
            <input type="number" name="price" required min="0" class="glass-input" placeholder="z.B. 15000" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-300">Standort *</label>
            <input type="text" name="city" required class="glass-input" placeholder="z.B. MÃ¼nchen" />
          </div>
        </div>

        <div class="mt-6">
          <label class="block text-sm font-medium mb-2 text-gray-300">VIN (optional)</label>
          <input type="text" name="vin" class="glass-input" placeholder="17-stellige Fahrzeug-Identifikationsnummer" />
        </div>

        <div class="mt-6">
          <label class="block text-sm font-medium mb-2 text-gray-300">ZusÃ¤tzliche Beschreibung (optional)</label>
          <textarea name="description" rows="3" class="glass-input" placeholder="z.B. Unfallfreiheit, Anzahl Vorbesitzer, Extras..."></textarea>
        </div>

        <div class="mt-6">
          <label class="block text-sm font-medium mb-2 text-gray-300">Foto des Fahrzeugs (optional)</label>
          <input type="file" id="photoInput" accept="image/*" class="glass-input" />
          <p class="text-xs text-gray-500 mt-2">Max. 10 MB. Wird nur temporÃ¤r verarbeitet.</p>
        </div>

        <button type="submit" class="neon-button w-full mt-8" id="submitBtn">ðŸš€ Analyse starten & bezahlen</button>
        <div class="mt-4 p-4 bg-blue-500/10 rounded-lg text-center">
          <p class="text-sm text-gray-400">ðŸ”” Nach erfolgreicher Zahlung werden Sie automatisch zurÃ¼ckgeleitet. Das Ergebnis erscheint hier.</p>
        </div>
      </form>
    </div>

    <div id="resultSection" class="result-card mt-12 hidden">
      <h3 class="text-2xl font-bold mb-4">Ergebnis</h3>
      <div id="planBadge" class="mb-3 text-sm text-gray-400"></div>
      <pre id="resultText" class="whitespace-pre-wrap text-gray-100"></pre>
      <div id="pdfBlock" class="mt-6 hidden">
        <a id="pdfLink" class="neon-button inline-block" href="#" target="_blank">ðŸ“„ PDF herunterladen</a>
      </div>
      <div class="mt-4">
        <button id="copyBtn" class="px-4 py-2 bg-white/10 rounded-lg">Text kopieren</button>
      </div>
    </div>
  </main>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-xl text-gray-300" id="loadingText">Weiterleitung zur Zahlung...</p>
      <p class="text-sm text-gray-500 mt-2">Bitte warten...</p>
    </div>
  </div>

  <script>
    // Stripe publishable Key dynamisch laden
    let stripe = null;
    async function getStripe() {
      if (stripe) return stripe;
      const cfg = await fetch('/api/config').then(r => r.json());
      stripe = Stripe(cfg.publishableKey);
      return stripe;
    }

    // Hintergrund-Partikel
    const canvas = document.getElementById('particles-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const particles = []; const particleCount = 80;
    class Particle {
      constructor() { this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.size=Math.random()*3+1; this.speedX=Math.random()*2-1; this.speedY=Math.random()*2-1; this.opacity=Math.random()*0.5+0.2; }
      update(){ this.x+=this.speedX; this.y+=this.speedY; if(this.x>canvas.width) this.x=0; if(this.x<0) this.x=canvas.width; if(this.y>canvas.height) this.y=0; if(this.y<0) this.y=canvas.height; }
      draw(){ ctx.fillStyle=`rgba(0, 212, 255, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); }
    }
    for(let i=0;i<particleCount;i++){ particles.push(new Particle()); }
    function animateParticles(){ ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{p.update(); p.draw();}); particles.forEach((p,i)=>{ for(let j=i+1;j<particles.length;j++){ const dx=particles[j].x-p.x; const dy=particles[j].y-p.y; const d=Math.sqrt(dx*dx+dy*dy); if(d<100){ ctx.strokeStyle=`rgba(0,212,255, ${0.1*(1-d/100)})`; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(particles[j].x,particles[j].y); ctx.stroke(); }}}); requestAnimationFrame(animateParticles);} animateParticles(); window.addEventListener('resize', ()=>{ canvas.width=window.innerWidth; canvas.height=window.innerHeight; });

    // Plan Auswahl
    let selectedPlan = 'standard';
    document.querySelectorAll('.plan-card').forEach(card => {
      card.addEventListener('click', function(){
        document.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('plan-selected'));
        this.classList.add('plan-selected'); selectedPlan = this.dataset.plan;
      });
    });

    const loadingOverlay = document.getElementById('loadingOverlay');
    function showLoading(msg){ document.getElementById('loadingText').textContent = msg || 'Bitte warten...'; loadingOverlay.style.display='flex'; }
    function hideLoading(){ loadingOverlay.style.display='none'; }

    // Datei-Upload (optional)
    async function uploadPhotoIfAny(){
      const fileInput = document.getElementById('photoInput');
      if (!fileInput.files || !fileInput.files[0]) return null;
      const form = new FormData();
      form.append('photo', fileInput.files[0]);
      const res = await fetch('/api/upload', { method: 'POST', body: form });
      if (!res.ok) throw new Error('Foto-Upload fehlgeschlagen');
      return res.json();
    }

    // Checkout Flow
    document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      showLoading('Weiterleitung zur Zahlung...');

      try {
        const formData = new FormData(e.target);
        const vehicleData = {
          brand: formData.get('brand'), model: formData.get('model'), year: parseInt(formData.get('year')), mileage: parseInt(formData.get('mileage')), price: parseInt(formData.get('price')), city: formData.get('city'), vin: formData.get('vin') || '', description: formData.get('description') || ''
        };

        let uploadId = null;
        try { const up = await uploadPhotoIfAny(); if (up && up.uploadId) uploadId = up.uploadId; } catch(err) { console.warn('Upload Ã¼bersprungen:', err.message); }

        const resp = await fetch('/api/create-checkout', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plan: selectedPlan, vehicleData, uploadId })
        });
        if (!resp.ok) { const err = await resp.json(); throw new Error(err.details || err.error || 'Fehler beim Checkout'); }
        const data = await resp.json();

        const stripe = await getStripe();
        const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });
        if (error) throw error;
      } catch (err) {
        alert('Fehler: ' + (err.message || 'Unbekannter Fehler'));
        hideLoading();
        submitBtn.disabled = false;
      }
    });

    // Ergebnis nach erfolgreicher Zahlung automatisch laden
    async function checkSuccess(){
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('canceled') === 'true') {
        alert('Zahlung abgebrochen. Sie kÃ¶nnen es jederzeit erneut versuchen.');
        window.history.replaceState({}, document.title, '/');
        return;
      }
      const sessionId = urlParams.get('session_id');
      if (urlParams.get('success') === 'true' && sessionId) {
        showLoading('Analyse lÃ¤uft...');
        await pollResult(sessionId);
        window.history.replaceState({}, document.title, '/');
      }
    }

    async function pollResult(sessionId){
      const start = Date.now();
      while (Date.now() - start < 180000) { // bis 3 Minuten
        const r = await fetch('/api/result?session_id=' + encodeURIComponent(sessionId));
        if (r.ok) {
          const data = await r.json();
          if (data.status === 'ready') { hideLoading(); renderResult(data); return; }
        }
        await new Promise(res => setTimeout(res, 2000));
      }
      hideLoading();
      alert('Die Analyse dauert lÃ¤nger als erwartet. Bitte laden Sie die Seite spÃ¤ter erneut und halten Sie die Session-ID bereit.');
    }

    function renderResult(data){
      const sec = document.getElementById('resultSection');
      const txt = document.getElementById('resultText');
      const badge = document.getElementById('planBadge');
      const pdfBlock = document.getElementById('pdfBlock');
      const pdfLink = document.getElementById('pdfLink');

      badge.textContent = 'Plan: ' + (data.plan || '').toUpperCase();
      txt.textContent = data.text || '';
      if (data.pdfUrl) { pdfBlock.classList.remove('hidden'); pdfLink.href = data.pdfUrl; }
      else { pdfBlock.classList.add('hidden'); }
      sec.classList.remove('hidden');
    }

    document.getElementById('copyBtn').addEventListener('click', async () => {
      const text = document.getElementById('resultText').textContent;
      try { await navigator.clipboard.writeText(text); alert('Kopiert.'); } catch { alert('Kopieren fehlgeschlagen.'); }
    });

    checkSuccess();
  </script>
</body>
</html>